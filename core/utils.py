import sys, os, yaml

def get_ext_path(executable_name):
    """
    ç»ˆæå¯»è·¯é›·è¾¾ï¼šåˆ¤æ–­å½“å‰æ˜¯å¼€å‘ç¯å¢ƒè¿˜æ˜¯å•æ–‡ä»¶ exe ç¯å¢ƒ
    """
    if hasattr(sys, '_MEIPASS'):
        # âœ¨ æ ¸å¿ƒä¿®å¤ï¼šæ‰“åŒ…å‘½ä»¤ç”¨çš„æ˜¯ ";."ï¼Œå¼•æ“è¢«é‡Šæ”¾åœ¨äº†ä¸´æ—¶ç›®å½•çš„æœ€å¤–å±‚æ ¹ç›®å½•ã€‚
        # æ‰€ä»¥è¿™é‡Œå»æ‰äº† "tools" è¿™ä¸€å±‚ï¼
        return os.path.join(sys._MEIPASS, executable_name)
    else:
        # å¼€å‘ç¯å¢ƒä¸‹ï¼ˆæºç è¿è¡Œï¼‰ï¼šè·å–é¡¹ç›®æ ¹ç›®å½•å¹¶è¿›å…¥ tools æ–‡ä»¶å¤¹
        base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        return os.path.join(base_dir, "tools", executable_name)
    
def get_app_dir():
    """
    å¤–éƒ¨ç‰©ç†è·¯å¾„é›·è¾¾ï¼šè·å–ç¨‹åºçœŸæ­£è¿è¡Œçš„ç‰©ç†ç›®å½•
    """
    import sys, os
    if getattr(sys, 'frozen', False):
        # å¦‚æœæ˜¯è¢«æ‰“åŒ…æˆäº† exeï¼Œè¿”å› exe æ‰€åœ¨çš„çœŸå®ç›®å½•
        return os.path.dirname(sys.executable)
    else:
        # âœ¨ æ ¸å¿ƒä¿®å¤ï¼šæŠ›å¼ƒ __file__ï¼Œæ”¹ç”¨ sys.argv[0]
        # sys.argv[0] æ°¸è¿œæŒ‡å‘ä½ å¯åŠ¨ç¨‹åºçš„é‚£ä¸ªå…¥å£æ–‡ä»¶ï¼ˆä¹Ÿå°±æ˜¯ main.pyï¼‰
        # è¿™æ ·æ— è®ºè¿™ä¸ªå‡½æ•°è¢«ç§»åˆ°å“ªä¸ªæ·±å±‚æ–‡ä»¶å¤¹ï¼Œå®ƒéƒ½èƒ½ç²¾å‡†å’¬æ­»é¡¹ç›®æ ¹ç›®å½•ï¼
        return os.path.dirname(os.path.abspath(sys.argv[0]))

def get_mapped_bitrate(slider_val):
    """å°† 0-100 çš„æ»‘å—å€¼è¿›è¡Œéçº¿æ€§(ä¸‰æ¬¡å¹‚)æ˜ å°„åˆ° 50-30000 kbps"""
    min_kbps = 50
    max_kbps = 30000
    # ä½¿ç”¨ä¸‰æ¬¡å¹‚å‡½æ•°ï¼šæ»‘å—åœ¨å‰åŠæ®µæ•°å­—å˜åŒ–ææ…¢ï¼ŒååŠæ®µå˜åŒ–æå¿«
    ratio = slider_val / 100.0
    mapped_val = min_kbps + (max_kbps - min_kbps) * (ratio ** 3)
    # æŠŠè®¡ç®—ç»“æœè§„æ•´ä¸€ä¸‹ï¼Œå‘ä¸‹å–æ•´åˆ°æœ€æ¥è¿‘çš„ 10ï¼Œè®© UI çœ‹èµ·æ¥æ›´æ•´æ´
    return int(round(mapped_val / 10) * 10)

def get_reverse_mapped_slider_val(target_kbps):
    """å°†çœŸå®çš„ç ç‡ (å¦‚ 5000 kbps) é€†å‘æ¨å¯¼å› 0-100 çš„æ»‘å—ç‰©ç†åˆ»åº¦"""
    min_kbps = 50
    max_kbps = 30000
    if target_kbps <= min_kbps: return 0
    if target_kbps >= max_kbps: return 100
    # é€†å‘å…¬å¼ï¼šå¼€ä¸‰æ¬¡æ–¹æ ¹
    ratio = ((target_kbps - min_kbps) / (max_kbps - min_kbps)) ** (1/3.0)
    return int(round(ratio * 100))

def read_yaml_config(filename):
    """é€šç”¨ YAML è¯»å–å·¥å…·ï¼šè‡ªåŠ¨å®šä½ config ç›®å½•å¹¶å®‰å…¨è¯»å–"""
    yaml_path = os.path.join(get_app_dir(), "config", filename)
    try:
        with open(yaml_path, 'r', encoding='utf-8') as f:
            data = yaml.safe_load(f)
            return data if data is not None else {}
    except FileNotFoundError:
        print(f"âš ï¸ æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶: {yaml_path}")
        return {}
    except Exception as e:
        print(f"ğŸ’¥ è¯»å– {filename} å‘ç”Ÿé”™è¯¯: {e}")
        return {}

def init_config_files():
    """åˆå§‹åŒ–é…ç½®æ–‡ä»¶ï¼šå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è‡ªåŠ¨ç”Ÿæˆé»˜è®¤é…ç½®"""
    import os
    app_dir = get_app_dir()
    config_dir = os.path.join(app_dir, "config")
    
    # å¦‚æœ config æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œå»ºä¸€ä¸ª
    if not os.path.exists(config_dir):
        os.makedirs(config_dir)
        
    presets_path = os.path.join(config_dir, "presets.yaml")
    tooltips_path = os.path.join(config_dir, "tooltips.yaml")
    
    # ==========================================
    # 1. è‡ªåŠ¨ç”Ÿæˆé¢„è®¾æ–‡ä»¶
    # ==========================================
    if not os.path.exists(presets_path):
        default_presets = """presets:
  - name: "ä¼šè®®å½•å±æè‡´ç˜¦èº« (AV1, 30å¸§, CQP)"
    requires: "av1"
    ui_state:
      fps: "24"
      res: "ä¿æŒæº"
      rc: "cqp"
      val: 45
      a_enc: "aac"
      a_bit: "128k"
      a_sample: "ä¿æŒæº"

  - name: "é«˜ç”»è´¨æ”¶è—ç‰ˆ (HEVC/H.265, VBR)"
    requires: "hevc"
    ui_state:
      fps: "ä¿æŒæº"
      res: "ä¿æŒæº"
      rc: "vbr"
      val: 5000
      a_enc: "aac"
      a_bit: "320k"
      a_sample: "ä¿æŒæº"

  - name: "è€è®¾å¤‡é«˜å…¼å®¹ç‰ˆ (H.264, CBR)"
    requires: "264"
    ui_state:
      fps: "ä¿æŒæº"
      res: "ä¿æŒæº"
      rc: "cbr"
      val: 2000
      a_enc: "aac"
      a_bit: "192k"
      a_sample: "ä¿æŒæº"

  - name: "å‹ç‰‡æˆ˜äº‰æœ€å°è§†é¢‘ (HEVC/H.265, VBR)"
    requires: "x265"
    ui_state:
      fps: "24"
      res: "720p"
      rc: "vbr"
      val: 100
      a_enc: "aac"
      a_bit: "64k"
      a_sample: "ä¿æŒæº"
"""
        with open(presets_path, 'w', encoding='utf-8') as f:
            f.write(default_presets)
            print("âœ¨ å·²è‡ªåŠ¨ç”Ÿæˆé»˜è®¤ presets.yaml")

    # ==========================================
    # 2. è‡ªåŠ¨ç”Ÿæˆç§‘æ™®æç¤ºæ–‡ä»¶
    # ==========================================
    if not os.path.exists(tooltips_path):
        default_tooltips = """encoder_tips:
  av1_nvenc: "ã€NVIDIA 40ç³»+ ä¸“äº«ã€‘ç›®å‰æœ€å…ˆè¿›çš„ç¡¬ä»¶AV1ç¼–ç å™¨ï¼Œæé«˜å‹ç¼©æ¯”ï¼Œç”»è´¨ä¼˜ç§€ã€‚"
  hevc_nvenc: "ã€NVIDIA ç¡¬ä»¶åŠ é€Ÿã€‘H.265ç¼–ç ã€‚å¹³è¡¡äº†ç”»è´¨ä¸æ–‡ä»¶ä½“ç§¯ï¼Œé€‚åˆå‹åˆ¶é«˜æ¸…æ”¶è—ã€‚ "
  h264_nvenc: "ã€NVIDIA ç¡¬ä»¶åŠ é€Ÿã€‘H.264ç¼–ç ã€‚å…¼å®¹æ€§ä¹‹ç‹ï¼Œå‹åˆ¶é€Ÿåº¦æå¿«ï¼Œé€‚åˆå¿«é€Ÿå‡ºç‰‡ã€‚"
  av1_amf: "ã€AMD 7000ç³»+ ä¸“äº«ã€‘AMD ç¡¬ä»¶AV1æ–¹æ¡ˆã€‚é€‚åˆæ–°ä¸€ä»£æ˜¾å¡ç”¨æˆ·è¿½æ±‚é«˜æ•ˆå‹ç¼©ã€‚"
  hevc_amf: "ã€AMD ç¡¬ä»¶åŠ é€Ÿã€‘HEVCç¼–ç ã€‚AMDæ ¸æ˜¾æˆ–ç‹¬æ˜¾ç”¨æˆ·å‹åˆ¶é«˜ç ç‡è§†é¢‘çš„é¦–é€‰ã€‚"
  h264_amf: "ã€AMD ç¡¬ä»¶åŠ é€Ÿã€‘H.264ç¼–ç ã€‚æè‡´çš„ç¼–ç é€Ÿåº¦ï¼Œé€‚åˆå¯¹å…¼å®¹æ€§è¦æ±‚é«˜çš„æ™®é€šè§†é¢‘ã€‚"
  av1_qsv: "ã€Intel Arc/æ–°é…·ç¿ä¸“äº«ã€‘Intel QSV ç¡¬ä»¶AV1ç¼–ç ã€‚æ•ˆç‡æé«˜ï¼Œå¤šåª’ä½“æ€§èƒ½å¼ºåŠ²ã€‚"
  hevc_qsv: "ã€Intel ç¡¬ä»¶åŠ é€Ÿã€‘HEVCç¼–ç ã€‚Intelæ ¸æ˜¾ç”¨æˆ·å‹åˆ¶é«˜ç”»è´¨è§†é¢‘çš„ä½åŠŸè€—æ–¹æ¡ˆã€‚"
  h264_qsv: "ã€Intel ç¡¬ä»¶åŠ é€Ÿã€‘H.264ç¼–ç ã€‚å¹¿æ³›åº”ç”¨äºæµåª’ä½“ï¼Œæ€§èƒ½ç¨³å®šä¸”å…¼å®¹æ€§å¥½ã€‚"
  libsvtav1: "ã€çº¯ CPU è½¯å‹ã€‘ç”± Intel/Netflix å¼€å‘ã€‚è™½ç„¶å‹åˆ¶ææ…¢ï¼Œä½†åŒä½“ç§¯ä¸‹ç”»è´¨æ˜¯ç›®å‰çš„ç¥è¯ã€‚"
  libx265: "ã€çº¯ CPU è½¯å‹ã€‘HEVC æ ‡å‡†å‹åˆ¶ã€‚é€‚åˆç”µå½±ã€çºªå½•ç‰‡æ·±åº¦å‹åˆ¶ï¼Œè¿½æ±‚æè‡´ç”»è´¨ç»†èŠ‚ã€‚"
  libx264: "ã€çº¯ CPU è½¯å‹ã€‘æœ€ç¨³ã€æœ€æ…¢ã€æœ€æ¸…æ™°çš„H.264æ–¹æ¡ˆã€‚ä¸ä¾èµ–æ˜¾å¡ï¼Œä¸æŒ‘é©±åŠ¨ã€‚"
  copy: "ã€æµå¤åˆ¶æ¨¡å¼ã€‘ä¸è¿›è¡Œä»»ä½•é‡æ–°ç¼–ç ã€‚ä»…æ›´æ¢å°è£…å®¹å™¨ï¼Œé€Ÿåº¦å–å†³äºç£ç›˜ï¼Œç”»è´¨0æŸå¤±ã€‚"

preset_tips:
  "ä¼šè®®å½•å±æè‡´ç˜¦èº« (AV1, 30å¸§, CQP)": "é‡‡ç”¨æœ€æ–°çš„ AV1 ç¼–ç ï¼Œé€‚åˆå½•åˆ¶å¹»ç¯ç‰‡ï¼Œæ–‡ä»¶ä½“ç§¯ç¼©å° 50% ä»¥ä¸Šã€‚"
  "é«˜ç”»è´¨æ”¶è—ç‰ˆ (HEVC/H.265, VBR)": "å…¼é¡¾ç”»è´¨ä¸å…¼å®¹æ€§ï¼Œé€‚åˆå­˜å‚¨ 1080p/4K ç”µå½±ï¼Œæ”¯æŒç¡¬ä»¶åŠ é€Ÿã€‚"
  "è€è®¾å¤‡é«˜å…¼å®¹ç‰ˆ (H.264, CBR)": "æœ€ä¼ ç»Ÿçš„æ ¼å¼ï¼Œå‡ ä¹èƒ½åœ¨ä»»ä½•ç ´æ—§çš„æ’­æ”¾å™¨æˆ–ç”µè§†ä¸Šæµç•…è¿è¡Œã€‚"
  "å‹ç‰‡æˆ˜äº‰æœ€å°è§†é¢‘ (HEVC/H.265, VBR)": "æè‡´å‹ç¼©ï¼Œçº¯å±æ•´æ´»å„¿ï¼Œæ–‡ä»¶ä½“ç§¯æå°ã€‚"
  "âš™ï¸ è‡ªå®šä¹‰å‚æ•°...": "è¿›å…¥æå®¢æ¨¡å¼ï¼Œæ‰‹åŠ¨å¾®è°ƒæ¯ä¸€é¡¹ç¡¬æ ¸å‹åˆ¶å‚æ•°ã€‚"

rc_tips:
  cqp: |
    <b>[ è´¨é‡æ’å®šæ¨¡å¼ ]</b><br>å›ºå®šæ¯ä¸€å¸§çš„å‹ç¼©å€ç‡ã€‚ä¸é™åˆ¶ç ç‡ï¼Œåªä¿è¯ç”»é¢æ¸…æ™°åº¦ã€‚<br><b>æ•°å€¼æ„ä¹‰ï¼š</b>0 ä¸ºæ— æŸï¼ˆæ–‡ä»¶å·¨å¤§ï¼‰ï¼Œ51 ä¸ºææ¨¡ç³Šã€‚<br><b>å»ºè®®èŒƒå›´ï¼š</b>18 - 28ã€‚æ•°å€¼è¶Šå°ï¼Œç”»è´¨è¶Šå¥½ï¼Œä½“ç§¯è¶Šå¤§ã€‚
  vbr: |
    <b>[ åŠ¨æ€ç ç‡æ¨¡å¼ ]</b><br>æ ¹æ®ç”»é¢å¤æ‚åº¦åˆ†é…ç ç‡ã€‚å¤æ‚ç”»é¢å¤šç»™ç‚¹ï¼Œé™æ­¢ç”»é¢å°‘ç»™ç‚¹ã€‚<br><b>æ•°å€¼æ„ä¹‰ï¼š</b>è®¾ç½®çš„æ˜¯â€˜ç›®æ ‡å¹³å‡ç ç‡â€™ã€‚<br><b>é€‚ç”¨åœºæ™¯ï¼š</b>æœ¬åœ°æ”¶è—ã€è§†é¢‘å‘å¸ƒã€‚æ˜¯å…¼é¡¾ä½“ç§¯ä¸ç”»è´¨çš„æœ€ä½³å¹³è¡¡æ–¹æ¡ˆã€‚
  cbr: |
    <b>[ å›ºå®šç ç‡æ¨¡å¼ ]</b><br>å…¨ç¨‹ä¿æŒæ’å®šçš„ä¼ è¾“é€Ÿç‡ï¼Œä¸é¡¾ç”»é¢å¤æ‚åº¦ï¼Œå¼ºè¡Œå¡«å……ç ç‡ã€‚<br><b>æ•°å€¼æ„ä¹‰ï¼š</b>è®¾ç½®çš„æ˜¯â€˜å›ºå®šä¼ è¾“é€Ÿç‡â€™ã€‚<br><b>é€‚ç”¨åœºæ™¯ï¼š</b>ç›´æ’­æ¨æµã€è€å¼ç¡¬ä»¶æ’­æ”¾ã€‚ç¼ºç‚¹æ˜¯ç®€å•ç”»é¢æµªè´¹ç©ºé—´ï¼Œå¤æ‚ç”»é¢å¯èƒ½æ¨¡ç³Šã€‚
"""
        with open(tooltips_path, 'w', encoding='utf-8') as f:
            f.write(default_tooltips)
            print("âœ¨ å·²è‡ªåŠ¨ç”Ÿæˆé»˜è®¤ tooltips.yaml")